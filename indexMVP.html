<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LuxeRide - Premium Airport Transfer Booking</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="LuxeRide">
    
    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="LuxeRide">
    <link rel="apple-touch-icon" href="/images/icon-152x152.png">
    
    <!-- SEO & Social -->
    <meta name="description" content="Premium airport transfer service in Miami. Book luxury vehicles for comfortable airport transportation.">
    <meta property="og:title" content="LuxeRide - Premium Airport Transfer">
    <meta property="og:description" content="Book luxury airport transfers in Miami">
    <meta property="og:image" content="/images/social-preview.png">
    <meta property="og:type" content="website">
    
    <!-- CSS Modular Architecture -->
    <link rel="stylesheet" href="css/style.css?v=refined-dark-theme"> <!-- Core Styles with Variables -->
    <link rel="stylesheet" href="css/vehicle-carousel.css?v=dark-theme-fix"> <!-- Vehicle Selection -->
    <link rel="stylesheet" href="css/booking-confirmation.css?v=dark-theme-fix" media="print" onload="this.media='all'; this.onload=null;"> <!-- Booking Confirmation Modal -->
    <link rel="stylesheet" href="css/maps-autocomplete.css?v=fix-visibility"> <!-- Maps Integration -->
</head>
<body>
    <div class="app-container">
        <!-- Start Search Button -->
        <button class="start-search-btn" id="startSearchBtn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
            <span>Book Airport Transfer</span>
        </button>
        
        <!-- Main Booking Container -->
        <div class="booking-container" id="bookingContainer">
            <!-- Progress Bar -->
            <div class="progress-bar">
                <div class="progress-step active" data-step="where">
                    <span class="step-number">1</span>
                    <span class="step-label">Where</span>
                </div>
                <div class="progress-line" id="progressLine"></div>
                <div class="progress-step" data-step="when">
                    <span class="step-number">2</span>
                    <span class="step-label">When</span>
                </div>
                <div class="progress-line" id="progressLine2"></div>
                <div class="progress-step" data-step="vehicle">
                    <span class="step-number">3</span>
                    <span class="step-label">Vehicle</span>
                </div>
            </div>
            
            <!-- Summary Bar -->
            <div class="summary-bar" id="summaryBar">
                <div class="summary-content">
                    <!-- Back button moved here -->
                    <button class="back-btn" id="summaryBackBtn" type="button" aria-label="Go back">Back</button>
                    
                    <!-- Centered route text -->
                    <span class="summary-value" id="routeSummaryText"></span>
                    
                    <!-- Existing edit button -->
                    <button class="edit-btn" id="editRouteBtn" type="button" aria-label="Edit route">Edit</button>
                </div>
            </div>
            
            <!-- Panels Container -->
            <div class="panels-wrapper" id="panelsWrapper">
                <!-- WHERE Panel -->
                <div class="panel active" id="wherePanel">
                    <div class="panel-content">
                        <!-- Route selection header removed for space optimization -->
                        
                        <!-- Mode Selector -->
                        <div class="mode-selector">
                            <button class="mode-btn active" data-mode="dropoff">
                                <span class="mode-icon">🛫</span>
                                <span class="mode-text">Going to Airport</span>
                            </button>
                            <button class="mode-btn" data-mode="pickup">
                                <span class="mode-icon">🛬</span>
                                <span class="mode-text">Arriving at Airport</span>
                            </button>
                        </div>

                        <!-- Dynamic Steps Container -->
                        <div class="steps-container" id="stepsContainer">
                            <!-- Step 1: Address -->
                            <div class="step-section" id="addressStep">
                                <!-- Step header removed for space optimization -->
                                <div class="input-wrapper">
                                    <input type="text" 
                                           id="addressInput" 
                                           class="address-input"
                                           placeholder="Enter pickup address, hotel, or landmark..."
                                           autocomplete="off">
                                    <div class="input-loading" id="addressLoading">
                                        <div class="spinner"></div>
                                    </div>
                                    <div class="autocomplete-dropdown" id="autocompleteDropdown"></div>
                                </div>
                                <div class="error-message" id="addressError">Please select a valid address from the suggestions.</div>
                            </div>

                            <!-- Flow Connector -->
                            <div class="flow-connector" id="flowConnector">
                                <div class="connector-line"></div>
                                <div class="connector-icon">↓</div>
                            </div>

                            <!-- Step 2: Airport -->
                            <div class="step-section" id="airportStep">
                                <div class="step-header">
                                    <span class="step-badge" id="airportBadge">
                                        <span id="airportTitle">Select Airport</span>
                                    </span>
                                </div>
                                <div class="airport-grid">
                                    <button class="airport-option" data-airport="MIA">
                                        <div class="airport-code">MIA</div>
                                        <div class="airport-name">Miami International</div>
                                    </button>
                                    <button class="airport-option" data-airport="FLL">
                                        <div class="airport-code">FLL</div>
                                        <div class="airport-name">Fort Lauderdale</div>
                                    </button>
                                    <button class="airport-option" data-airport="PBI">
                                        <div class="airport-code">PBI</div>
                                        <div class="airport-name">Palm Beach</div>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="panel-actions">
                        <button class="continue-btn" id="continueBtn" disabled>
                            Continue to Date & Time
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 18l6-6-6-6"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- WHEN Panel -->
                <div class="panel" id="whenPanel">
                    <button class="back-btn" id="backBtn">
                        <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M13 14L7 10L13 6" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>Back</span>
                    </button>
                    
                    <div class="panel-content" style="padding-top: 20px;">
                        <!-- Date Selection moved up, label removed -->
                        <div class="date-section">
                            <div class="date-selection">
                                <button type="button" class="date-btn active" id="todayBtn">
                                    <span class="date-label">Today</span>
                                    <span class="date-value" id="todayDate">Jul 9</span>
                                </button>
                                <button type="button" class="date-btn" id="tomorrowBtn">
                                    <span class="date-label">Tomorrow</span>
                                    <span class="date-value" id="tomorrowDate">Jul 10</span>
                                </button>
                                <button type="button" class="date-btn" id="otherDatesBtn">
                                    <span class="date-label">Other dates</span>
                                    <span class="date-value">📅</span>
                                </button>
                            </div>
                            
                            <!-- Calendar Container -->
                            <div class="calendar-container" id="calendarContainer">
                                <div class="calendar-header">
                                    <button class="calendar-nav" id="prevMonthBtn">◀</button>
                                    <h4 id="calendarMonthYear">July 2025</h4>
                                    <button class="calendar-nav" id="nextMonthBtn">▶</button>
                                </div>
                                <div class="calendar-grid" id="calendarGrid"></div>
                            </div>
                        </div>
                        
                        <!-- Time Selection -->
                        <div class="time-section">
                            <h3 class="section-label">Time</h3>
                            <div class="time-selector">
                                <div class="time-input-group">
                                    <select id="hourSelect" class="time-select"></select>
                                    <span class="time-separator">:</span>
                                    <select id="minuteSelect" class="time-select"></select>
                                    <select id="ampmSelect" class="time-select">
                                        <option value="AM">AM</option>
                                        <option value="PM" selected>PM</option>
                                    </select>
                                </div>
                                <div class="time-note" id="timeNote"></div>
                            </div>
                        </div>

                        <!-- Flight Number Input -->
                        <div class="flight-section" id="flightSection">
                            <h3 class="section-label">Flight Information <span style="color: var(--text-secondary); font-weight: 400; font-size: 12px;">(Optional)</span></h3>
                            <input type="text" 
                                   id="flightInput" 
                                   class="flight-input"
                                   placeholder="Enter flight number (e.g., AA123)"
                                   autocomplete="off">
                        </div>
                        
                        <!-- Trip Info moved here from panel-actions -->
                        <div class="arrival-info">
                            <div class="arrival-icon">📍</div>
                            <div class="arrival-details">
                                <div class="arrival-title" id="arrivalTitle">Drop-off at airport approx. --</div>
                                <div class="trip-duration" id="tripDuration">Estimated ride duration of -- min</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="panel-actions">
                        <button class="continue-btn" id="vehicleSelectionBtn">
                            Continue to Vehicle Selection
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 18l6-6-6-6"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- VEHICLE Panel - Mobile Optimized -->
                <div class="panel" id="vehiclePanel">
                    <div class="map-section">
                        <div id="vehicleMap"></div>
                        
                        <button class="back-btn" id="vehicleBackBtn">←</button>
                        
                        <div class="map-time-badge arrival-time">
                            <span>📍</span>
                            <span id="mapArrivalTime">4:30</span>
                        </div>
                        <div class="map-time-badge pickup-time">
                            <span id="mapPickupTime">5:59</span>
                            <span class="time-period">PM</span>
                        </div>
                        <div class="map-time-badge dropoff-label">
                            <span class="label-text">Drop-off</span>
                            <span class="location-text" id="mapLocationText">Miami International...</span>
                        </div>
                    </div>
                    
                    <div class="content-section">
                        <!-- Passenger and Notes Controls -->
                        <div class="controls-row">
                            <button class="control-button passenger-select" onclick="PassengerModal.getInstance().open()">
                                <span class="control-icon">👤</span>
                                <span class="control-text">For myself</span>
                                <span class="dropdown-arrow">▼</span>
                            </button>
                            <button class="control-button add-notes" onclick="PickupNoteModal.getInstance().open()">
                                <span class="control-icon">➕</span>
                                <span class="control-text">Add pickup notes</span>
                            </button>
                        </div>
                        
                        <!-- Vehicle Display Mobile -->
                        <div class="vehicle-display-mobile">
                            <div class="carousel-container">
                                <div class="carousel-wrapper">
                                    <div class="carousel-track" id="carouselTrack">
                                        <!-- Tesla Model Y -->
                                        <div class="vehicle-card active" data-vehicle="tesla" data-base-price="132">
                                            <div class="vehicle-image-section">
                                                <img src="./images/luxury-sedan.jpg" 
                                                     alt="Tesla Model Y" 
                                                     class="vehicle-image"
                                                     loading="lazy"
                                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                                <div class="vehicle-image-fallback">
                                                    <div class="fallback-icon">🚗</div>
                                                    <div>Tesla Model Y</div>
                                                </div>
                                                <div class="selection-badge"></div>
                                            </div>
                                            
                                            <div class="vehicle-info">
                                                <div class="vehicle-header">
                                                    <div class="vehicle-details">
                                                        <h3 class="vehicle-name">Electric Sedan</h3>
                                                        <div class="vehicle-specs">
                                                            <div class="spec-item">
                                                                <span class="spec-icon">👤</span>
                                                                <span class="spec-value">3</span>
                                                            </div>
                                                            <div class="spec-item">
                                                                <span class="spec-icon">🧳</span>
                                                                <span class="spec-value">2</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="vehicle-price" id="tesla-price">$132.96</div>
                                                </div>
                                                <p class="vehicle-subtitle">Mercedes EQS or similar</p>
                                            </div>
                                        </div>

                                        <!-- Cadillac Escalade -->
                                        <div class="vehicle-card" data-vehicle="escalade" data-base-price="165">
                                            <div class="vehicle-image-section">
                                                <img src="./images/premium-suv-escalade.jpg" 
                                                     alt="Cadillac Escalade" 
                                                     class="vehicle-image"
                                                     loading="lazy"
                                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                                <div class="vehicle-image-fallback">
                                                    <div class="fallback-icon">🚙</div>
                                                    <div>Cadillac Escalade</div>
                                                </div>
                                                <div class="popular-badge">Most Popular</div>
                                                <div class="selection-badge"></div>
                                            </div>
                                            
                                            <div class="vehicle-info">
                                                <div class="vehicle-header">
                                                    <div class="vehicle-details">
                                                        <h3 class="vehicle-name">Premium SUV</h3>
                                                        <div class="vehicle-specs">
                                                            <div class="spec-item">
                                                                <span class="spec-icon">👤</span>
                                                                <span class="spec-value">7</span>
                                                            </div>
                                                            <div class="spec-item">
                                                                <span class="spec-icon">🧳</span>
                                                                <span class="spec-value">8</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="vehicle-price" id="escalade-price">$165.50</div>
                                                </div>
                                                <p class="vehicle-subtitle">Cadillac Escalade or similar</p>
                                            </div>
                                        </div>

                                        <!-- Mercedes Sprinter -->
                                        <div class="vehicle-card" data-vehicle="sprinter" data-base-price="220">
                                            <div class="vehicle-image-section">
                                                <img src="./images/vip-sprinter.jpg" 
                                                     alt="Mercedes Sprinter Van" 
                                                     class="vehicle-image"
                                                     loading="lazy"
                                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                                <div class="vehicle-image-fallback">
                                                    <div class="fallback-icon">🚐</div>
                                                    <div>Mercedes Sprinter</div>
                                                </div>
                                                <div class="selection-badge"></div>
                                            </div>
                                            
                                            <div class="vehicle-info">
                                                <div class="vehicle-header">
                                                    <div class="vehicle-details">
                                                        <h3 class="vehicle-name">Premium Van</h3>
                                                        <div class="vehicle-specs">
                                                            <div class="spec-item">
                                                                <span class="spec-icon">👤</span>
                                                                <span class="spec-value">14</span>
                                                            </div>
                                                            <div class="spec-item">
                                                                <span class="spec-icon">🧳</span>
                                                                <span class="spec-value">12</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="vehicle-price" id="sprinter-price">$220.00</div>
                                                </div>
                                                <p class="vehicle-subtitle">Mercedes Sprinter or similar</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <button class="carousel-nav prev" id="prevBtn">‹</button>
                                <button class="carousel-nav next" id="nextBtn">›</button>
                            </div>
                        </div>
                        
                        <!-- Payment Row -->
                        <!-- Payment Row moved to panel-actions below -->
                        <div class="payment-row-mobile">
                            <button class="payment-method-mobile" onclick="PaymentModal.getInstance().open()">
                                <div class="card-icon">VISA</div>
                                <span class="payment-details">Visa, •••• 1187</span>
                                <span class="dropdown-arrow">▼</span>
                            </button>
                            <button class="promo-button-mobile" onclick="PromotionModal.getInstance().open()">
                                <span class="control-icon">🎫</span>
                                <span>Add promotion</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="panel-actions">
                        <div class="schedule-section">
                            <button class="book-btn" id="bookBtn">
                                <span class="btn-main-text">Schedule ride</span>
                                <span class="btn-sub-text">Wed, Jul 23, 2025 · 9:32 PM</span>
                            </button>
                            <button class="calendar-button-mobile" onclick="modifyDateTime()">📅</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- Supabase SDK - Load First for Authentication -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="./config.js"></script>
    <script src="./supabase.js"></script>
    
    <!-- Authentication Check - Run IMMEDIATELY -->
    <script>
        // Initialize Supabase using centralized config
        const supabase = window.supabaseClient || window.supabase.createClient(
            window.APP_CONFIG?.SUPABASE_URL || 'https://hncpybxwblpkyxvskoxd.supabase.co',
            window.APP_CONFIG?.SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhuY3B5Ynh3Ymxwa3l4dnNrb3hkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNDE5MDIsImV4cCI6MjA3MDcxNzkwMn0.aXmiOWS1FVxBaQMXoenoTdUlbOFYuYTLVc-tD3FnheA'
        );
        
        // Store user session globally
        let currentUser = null;
        
        // Development mode bypass - set this to true to skip authentication
        const DEV_MODE = true;  // Change to false for production
        
        // Check authentication on page load
        (async function checkAuth() {
            // Skip auth check in development mode
            if (DEV_MODE) {
                console.log('🔧 Development mode - bypassing authentication');
                currentUser = {
                    id: 'dev-user-123',
                    email: 'dev@example.com',
                    phone: '+13055551234'
                };
                // Add dev mode header
                addUserHeader(currentUser);
                // Initialize the app
                if (window.bookingApp) {
                    bookingApp.init();
                }
                return;
            }
            
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                // No session - redirect to login page
                window.location.href = '/dev/templates/LandingLOGIN.html';
                return;
            }
            // User is authenticated
            currentUser = session.user;
            console.log('User authenticated:', session.user.id);
            
            // Add user info to header
            addUserHeader(session.user);
        })();
        
        // Logout function
        async function logout() {
            const { error } = await supabase.auth.signOut();
            if (!error) {
                window.location.href = '/dev/templates/LandingLOGIN.html';
            }
        }
        
        // Add user header with logout button
        function addUserHeader(user) {
            const userInfo = user.email || user.phone || 'User';
            const devBadge = DEV_MODE ? '<span style="background: #FF9500; color: white; padding: 4px 8px; border-radius: 4px; margin-right: 10px; font-size: 12px; font-weight: 600;">DEV MODE</span>' : '';
            const headerHTML = `
                <div id="userHeader" style="position: fixed; top: 0; right: 0; padding: 15px 20px; background: rgba(44, 44, 46, 0.95); border-radius: 0 0 0 12px; z-index: 1000; display: flex; align-items: center; gap: 15px; backdrop-filter: blur(10px); border: 1px solid rgba(255, 149, 0, 0.2);">
                    ${devBadge}
                    <span style="color: white; font-size: 14px;">${userInfo}</span>
                    <button onclick="logout()" style="background: linear-gradient(135deg, #FF9933, #FF5733); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                        Sign Out
                    </button>
                </div>
            `;
            document.body.insertAdjacentHTML('afterbegin', headerHTML);
        }
    </script>
    
    <!-- Core Utilities - Load First -->
    <script src="./debug.js"></script>
    <script src="./error-handler.js"></script>
    
    <!-- Stripe SDK - Load before payment modules -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <!-- Modal Controllers -->
    <script src="./js/passenger-modal.js?v=3"></script>
    <script src="./js/pickup-note-modal.js?v=1"></script>
    <script src="./js/promotion-modal.js?v=1"></script>
    <script src="./js/payment-modal.js?v=1"></script>
    
    <!-- Stripe Payment Integration -->
    <script src="./js/stripe-payment.js?v=2"></script>
    
    <!-- Main Application Scripts -->
    <!-- Autocomplete will be loaded lazily when needed -->
    <script>
        // Main Application Class
        class AirportBookingApp {
            constructor() {
                this.state = {
                    mode: 'dropoff',
                    locations: {
                        address: null,
                        airport: null
                    },
                    route: {
                        distance: null,
                        duration: null,
                        price: null
                    },
                    dateTime: {
                        date: new Date(),
                        time: null
                    },
                    flight: '',
                    vehicle: {
                        selected: null,
                        pricing: null
                    },
                    passengers: 1,
                    guestData: null,
                    pickupNotes: null,
                    paymentMethod: 'visa-1187',
                    promoCode: null,
                    ui: {
                        currentPanel: 'where'
                    }
                };
                
                this.els = {};
                this.autocomplete = null;
                this.vehicleMap = null;
                this.directionsRenderer = null;
                this.pricingService = null;
                
                this.init();
            }
            
            init() {
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => this.setup());
                } else {
                    this.setup();
                }
                
                this.initializePricingService();
            }
            
            async initializePricingService() {
                try {
                    console.log('🔄 Loading pricing service...');
                    const pricingModule = await import('./pricing.js');
                    this.pricingService = pricingModule.pricingService;
                    
                    if (!this.pricingService) {
                        throw new Error('pricingService not found in module exports');
                    }
                    
                    this.vehicleConfig = this.pricingService.getAllVehicleConfigs();
                    console.log('✅ Pricing service loaded successfully');
                    console.log('📊 Vehicle configurations:', this.vehicleConfig);
                    
                    // Test psychological pricing to verify it's working
                    const testPrice = this.pricingService.applyPsychologicalPricing(234.67);
                    console.log('💰 Psychological pricing test: $234.67 → $' + testPrice);
                    
                    // Validate configuration
                    const validation = this.pricingService.validateConfiguration();
                    if (!validation.valid) {
                        console.warn('⚠️ Pricing configuration issues:', validation.issues);
                    }
                    
                } catch (error) {
                    console.error('❌ Failed to load pricing service:', error);
                    console.log('🔄 Using default vehicle configuration');
                    
                    // Import default configuration from config.js
                    try {
                        const configModule = await import('./config.js');
                        this.vehicleConfig = configModule.DEFAULT_VEHICLE_CONFIG;
                        console.log('✅ Default vehicle configuration loaded');
                    } catch (configError) {
                        console.error('❌ Failed to load config file, using hardcoded fallback');
                        // Ultimate fallback if config.js can't be loaded
                        this.vehicleConfig = {
                            tesla: { 
                                name: 'Tesla Model Y',
                                basePrice: 125,
                                capacity: { passengers: 4, bags: 4 } 
                            },
                            escalade: { 
                                name: 'Cadillac Escalade',
                                basePrice: 169,
                                capacity: { passengers: 7, bags: 8 } 
                            },
                            sprinter: { 
                                name: 'Mercedes Sprinter',
                                basePrice: 219,
                                capacity: { passengers: 12, bags: 15 } 
                            }
                        };
                    }
                    
                    this.pricingService = null;
                }
            }
            
            setup() {
                console.log('🔄 Setting up AirportBookingApp...');
                this.cacheElements();
                this.bindEvents();
                this.initializeDateTime();
                console.log('✅ AirportBookingApp setup complete');
            }
            
            cacheElements() {
                const elementIds = [
                    'startSearchBtn', 'bookingContainer', 'panelsWrapper', 'progressLine', 'progressLine2',
                    'summaryBar', 'addressInput', 'addressLoading', 'autocompleteDropdown',
                    'addressStep', 'airportStep', 
                    'airportBadge', 'airportTitle', 'flowConnector',
                    'hourSelect', 'minuteSelect', 'ampmSelect', 'timeNote', 'continueBtn',
                    'backBtn', 'summaryBackBtn', 'bookBtn', 'editRouteBtn', 'routeSummaryText',
                    'flightInput', 'flightSection', 'arrivalTitle', 'tripDuration',
                    'todayBtn', 'tomorrowBtn', 'otherDatesBtn', 'todayDate', 'tomorrowDate',
                    'calendarContainer', 'calendarMonthYear', 'calendarGrid', 'prevMonthBtn', 'nextMonthBtn',
                    'vehicleSelectionBtn', 'vehicleBackBtn', 'vehiclePanel', 'vehicleMap',
                    'mapArrivalTime', 'mapPickupTime', 'mapLocationText'
                ];
                
                let foundElements = 0;
                elementIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        this.els[id] = el;
                        foundElements++;
                    } else {
                        console.warn(`Element not found: ${id}`);
                    }
                });
                
                this.els.modeBtns = document.querySelectorAll('.mode-btn');
                this.els.airportOptions = document.querySelectorAll('.airport-option');
                this.els.progressSteps = document.querySelectorAll('.progress-step');
                this.els.dateBtns = document.querySelectorAll('.date-btn');
                this.els.vehicleCards = document.querySelectorAll('.vehicle-card');
                
                debug.info(`Cached ${foundElements}/${elementIds.length} elements`);
                debug.info(`Found ${this.els.modeBtns.length} mode buttons, ${this.els.airportOptions.length} airport options`);
            }
            
            async initializeAutocomplete() {
                try {
                    // Check if required elements exist
                    if (!this.els.addressInput) {
                        debug.warn('Cannot initialize autocomplete: addressInput element not found');
                        return;
                    }
                    if (!this.els.autocompleteDropdown) {
                        debug.warn('Cannot initialize autocomplete: autocompleteDropdown element not found');
                        return;
                    }
                
                    
                    if (!google || !google.maps) {
                        throw new Error('Google Maps not loaded');
                    }
                    
                    // Show loading state
                    if (this.els.addressInput) {
                        this.els.addressInput.placeholder = 'Loading address search...';
                    }
                    
                    const [placesLib, autocompleteModule] = await Promise.all([
                        google.maps.importLibrary("places"),
                        import('./autocomplete.js')
                    ]);
                    
                    const { CustomAutocomplete } = autocompleteModule;
                    
                    this.autocomplete = new CustomAutocomplete(
                            this.els.addressInput, 
                            this.els.autocompleteDropdown,
                            (locationData) => {
                                this.handleAddressSelected({
                                    placeId: locationData.place?.id || 'unknown',
                                    description: locationData.address
                                });
                                
                                const coords = locationData.coordinates || { lat: 25.7617, lng: -80.1918 };
                                this.handleAddressCoordinates({
                                    lat: coords.lat,
                                    lng: coords.lng,
                                    address: locationData.address
                                });
                            }
                        );
                        
                        // Add event listeners with safety checks
                        if (this.els.addressInput) {
                            this.els.addressInput.addEventListener('place-selected', (e) => {
                                this.handleAddressSelected(e.detail);
                            });
                            
                            this.els.addressInput.addEventListener('place-coordinates', (e) => {
                                this.handleAddressCoordinates(e.detail);
                            });
                            
                            this.els.addressInput.addEventListener('validation-cleared', () => {
                                this.handleAddressValidationCleared();
                            });
                        }
                        
                    
                    // Restore placeholder
                    if (this.els.addressInput) {
                        this.els.addressInput.placeholder = 'Enter pickup address, hotel, or landmark...';
                    }
                    
                    debug.success('Autocomplete initialized with lazy loading');
                    
                } catch (error) {
                    errorHandler.handleError({
                        message: 'Failed to initialize address search',
                        error,
                        context: 'autocomplete',
                        userMessage: 'Address search is temporarily unavailable. You can still type your address manually.'
                    });
                    
                    // Restore placeholder
                    if (this.els.addressInput) {
                        this.els.addressInput.placeholder = 'Enter pickup address, hotel, or landmark...';
                    }
                }
            }
            
            bindEvents() {
                // Lazy load autocomplete on first interaction
                let autocompleteLoaded = false;
                this.els.addressInput?.addEventListener('focus', async () => {
                    if (!autocompleteLoaded && !this.autocomplete) {
                        autocompleteLoaded = true;
                        await this.initializeAutocomplete();
                    }
                }, { once: true });
                
                this.els.startSearchBtn?.addEventListener('click', () => this.startBooking());
                
                this.els.modeBtns.forEach(btn => {
                    btn.addEventListener('click', () => this.setMode(btn.dataset.mode));
                });
                
                this.els.airportOptions.forEach(option => {
                    option.addEventListener('click', () => this.selectAirport(option.dataset.airport));
                });
                
                this.els.continueBtn?.addEventListener('click', () => this.navigateToPanel('when'));
                this.els.backBtn?.addEventListener('click', () => this.navigateToPanel('where'));
                this.els.summaryBackBtn?.addEventListener('click', () => this.goBackFromSummary());
                this.els.vehicleSelectionBtn?.addEventListener('click', () => this.navigateToPanel('vehicle'));
                this.els.vehicleBackBtn?.addEventListener('click', () => this.navigateToPanel('when'));
                this.els.bookBtn?.addEventListener('click', () => this.confirmBooking());
                this.els.editRouteBtn?.addEventListener('click', () => this.navigateToPanel('where'));
                
                this.els.vehicleCards?.forEach(card => {
                    card.addEventListener('click', () => this.selectVehicle(card.dataset.vehicle));
                });
                
                this.els.flightInput?.addEventListener('input', (e) => {
                    this.state.flight = e.target.value;
                });
            }
            
            startBooking() {
                try {
                    debug.log('Starting booking flow');
                    
                    if (!this.els.startSearchBtn) {
                        console.error('Start button not found');
                        return;
                    }
                    
                    if (!this.els.bookingContainer) {
                        console.error('Booking container not found');
                        return;
                    }
                    
                    this.els.startSearchBtn.style.display = 'none';
                    this.els.bookingContainer.classList.add('active');
                    
                    setTimeout(() => {
                        if (this.state.mode === 'dropoff') {
                            this.els.addressInput?.focus();
                        }
                    }, 300);
                } catch (error) {
                    console.error('Error starting booking:', error);
                }
            }
            
            setMode(mode) {
                this.state.mode = mode;
                
                this.els.modeBtns.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.mode === mode);
                });
                
                this.updateStepOrder(mode === 'dropoff');
                this.resetSelections();
            }
            
            updateStepOrder(isDropoff) {
                this.els.addressStep.style.order = isDropoff ? '1' : '3';
                this.els.flowConnector.style.order = '2';
                this.els.airportStep.style.order = isDropoff ? '3' : '1';
                
                // Badge numbers removed for space optimization
                // Update airport title only
                if (this.els.addressTitle) {
                    this.els.addressTitle.textContent = isDropoff ? 'Pickup Location' : 'Destination Address';
                }
                this.els.airportTitle.textContent = isDropoff ? 'Destination Airport' : 'Pickup Airport';
                
                if (isDropoff) {
                    this.els.addressInput.disabled = false;
                    this.els.addressStep.classList.remove('disabled');
                } else {
                    const shouldDisableAddress = !this.state.locations.airport;
                    this.els.addressInput.disabled = shouldDisableAddress;
                    this.els.addressStep.classList.toggle('disabled', shouldDisableAddress);
                }
                
                this.updateAirportStepState();
                
                this.els.flightSection.style.display = this.state.mode === 'pickup' ? 'block' : 'none';
            }
            
            updateAirportStepState() {
                const shouldDisableAirport = this.state.mode === 'dropoff' && !this.state.locations.address;
                this.els.airportStep.classList.toggle('disabled', shouldDisableAirport);
                
                this.els.airportOptions.forEach(option => {
                    option.disabled = shouldDisableAirport;
                });
            }
            
            resetSelections() {
                this.state.locations = { address: null, airport: null };
                this.state.route = { distance: null, duration: null, price: null };
                
                this.els.addressInput.value = '';
                if (this.autocomplete) {
                    this.autocomplete.clearValidation();
                }
                
                this.els.airportOptions.forEach(opt => opt.classList.remove('selected'));
                // Address badge removed for space optimization
                this.els.airportBadge.classList.remove('completed', 'active');
                this.els.flowConnector.classList.remove('active');
                
                this.updateStepOrder(this.state.mode === 'dropoff');
                
                this.updateContinueButton();
            }
            
            handleAddressSelected(detail) {
                this.updateAddressStepState();
                this.updateAirportStepState();
                this.updateContinueButton();
            }
            
            handleAddressCoordinates(detail) {
                this.state.locations.address = {
                    address: detail.address,
                    coordinates: { lat: detail.lat, lng: detail.lng }
                };
                
                this.updateAddressStepState();
                this.calculateRoute();
            }
            
            handleAddressValidationCleared() {
                this.state.locations.address = null;
                this.updateAddressStepState();
                this.updateAirportStepState();
                this.updateContinueButton();
            }
            
            updateAddressStepState() {
                const isValidated = this.autocomplete?.isValidated && this.state.locations.address;
                // Address badge removed for space optimization
                
                this.els.airportBadge.classList.toggle('active', isValidated);
                
                if (isValidated) {
                    this.els.flowConnector.classList.add('active');
                } else {
                    this.els.flowConnector.classList.remove('active');
                    this.els.airportBadge.classList.remove('active');
                }
            }
            
            selectAirport(airportCode) {
                if (this.state.mode === 'dropoff' && !this.state.locations.address) {
                    return;
                }
                
                this.state.locations.airport = {
                    code: airportCode,
                    name: this.getAirportName(airportCode)
                };
                
                this.els.airportOptions.forEach(opt => {
                    opt.classList.toggle('selected', opt.dataset.airport === airportCode);
                });
                
                this.els.airportBadge.classList.remove('active');
                this.els.airportBadge.classList.add('completed');
                
                if (this.state.mode === 'pickup') {
                    this.els.addressInput.disabled = false;
                    this.els.addressStep.classList.remove('disabled');
                    setTimeout(() => {
                        this.els.addressInput?.focus();
                    }, 100);
                }
                
                this.updateContinueButton();
                this.calculateRoute();
            }
            
            getAirportName(code) {
                const names = {
                    'MIA': 'Miami International',
                    'FLL': 'Fort Lauderdale',
                    'PBI': 'Palm Beach'
                };
                return names[code] || code;
            }
            
            async calculateRoute() {
                if (!this.state.locations.address || !this.state.locations.airport) return;
                
                try {
                    const routeData = await this.getRouteData(
                        this.state.locations.address.coordinates,
                        this.state.locations.airport.code
                    );
                    
                    if (routeData) {
                        this.state.route = routeData;
                        
                        // Update vehicle prices once route data is available
                        console.log('📍 Route calculated, updating vehicle prices...');
                        this.updateVehiclePrices();
                    }
                    
                    this.updateRouteDisplay();
                    
                } catch (error) {
                    console.error('Route calculation error:', error);
                }
            }
            
            async getRouteData(addressCoords, airportCode) {
                try {
                    const airportCoords = this.getAirportCoordinates(airportCode);
                    if (!airportCoords) {
                        return null;
                    }
                    
                    const addressString = this.state.locations.address?.address;
                    if (!addressString) {
                        return null;
                    }
                    
                    let origin, destination;
                    
                    if (this.state.mode === 'dropoff') {
                        origin = addressString;
                        destination = `${airportCoords.lat},${airportCoords.lng}`;
                    } else {
                        origin = `${airportCoords.lat},${airportCoords.lng}`;
                        destination = addressString;
                    }
                    
                    // Use Railway proxy for directions
                    const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                    const directionsUrl = isLocal ? 'http://localhost:3001/api/directions' : 'https://reliable-warmth-production-d382.up.railway.app/api/directions';
                    const response = await fetch(directionsUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            origin: origin,
                            destination: destination,
                            mode: 'driving',
                            units: 'imperial',
                            departure_time: 'now',
                            traffic_model: 'best_guess'
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to fetch directions');
                    }

                    const result = await response.json();
                    
                    if (result.status !== 'OK' || !result.route) {
                        throw new Error(`Directions service failed: ${result.status}`);
                    }
                    
                    const route = result.route;
                    
                    const distanceInMiles = route.distance.value * 0.000621371;
                    
                    let durationInMinutes;
                    if (route.duration_in_traffic) {
                        durationInMinutes = Math.round(route.duration_in_traffic.value / 60);
                    } else {
                        durationInMinutes = Math.round(route.duration.value / 60);
                    }
                    
                    return {
                        distance: Math.round(distanceInMiles * 10) / 10,
                        duration: durationInMinutes,
                        price: null,
                        realData: true
                    };
                    
                } catch (error) {
                    console.error('Error getting route data:', error);
                    return null;
                }
            }
            
            getAirportCoordinates(airportCode) {
                const airportCoords = {
                    'MIA': { lat: 25.7931, lng: -80.2906 },
                    'FLL': { lat: 26.0742, lng: -80.1506 },
                    'PBI': { lat: 26.6832, lng: -80.0956 }
                };
                return airportCoords[airportCode];
            }
            
            formatDuration(minutes) {
                if (minutes < 60) {
                    return `${minutes} min`;
                } else {
                    const hours = Math.floor(minutes / 60);
                    const remainingMinutes = minutes % 60;
                    if (remainingMinutes === 0) {
                        return `${hours} hr`;
                    } else {
                        return `${hours} hr ${remainingMinutes} min`;
                    }
                }
            }
            
            updateRouteDisplay() {
                const now = new Date();
                const arrivalTime = new Date(now.getTime() + this.state.route.duration * 60 * 1000);
                const formattedArrivalTime = arrivalTime.toLocaleTimeString('en-US', {
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });
                
                const formattedDuration = this.formatDuration(this.state.route.duration);
                
                const actionText = this.state.mode === 'dropoff' ? 'Drop-off' : 'Drop off';
                const locationText = this.state.mode === 'dropoff' ? 'airport' : 'destination';
                
                this.els.arrivalTitle.textContent = `${actionText} at ${locationText} approx. ${formattedArrivalTime}`;
                this.els.tripDuration.textContent = `Estimated ride duration of ${formattedDuration}`;
                
                if (this.state.route.realData) {
                    this.els.tripDuration.textContent += ' (live data)';
                } else {
                    this.els.tripDuration.textContent += ' (estimated)';
                }
            }
            
            canContinue() {
                return this.state.locations.address && this.state.locations.airport;
            }
            
            updateContinueButton() {
                const enabled = this.canContinue();
                this.els.continueBtn.disabled = !enabled;
            }
            
            navigateToPanel(panel) {
                if (panel === 'when' && !this.canContinue()) return;
                if (panel === 'vehicle' && !this.canContinue()) return;
                
                this.els.panelsWrapper.classList.remove('show-when', 'show-vehicle');
                this.els.progressLine.classList.remove('active');
                this.els.summaryBar.classList.remove('visible');
                
                if (panel === 'when') {
                    this.els.panelsWrapper.classList.add('show-when');
                    this.els.progressLine.classList.add('active');
                    this.els.summaryBar.classList.add('visible');
                    this.updateProgressSteps('when');
                    this.updateSummary();
                } else if (panel === 'vehicle') {
                    this.els.panelsWrapper.classList.add('show-vehicle');
                    this.els.progressLine.classList.add('active');
                    this.els.summaryBar.classList.add('visible');
                    this.updateVehiclePrices();
                    this.updateProgressSteps('vehicle');
                    this.updateSummary();
                    this.updateVehicleMap();
                    this.updateMapBadges();
                    this.preloadVehicleImages();
                } else {
                    this.updateProgressSteps('where');
                }
                
                this.state.ui.currentPanel = panel;
            }
            
            goBackFromSummary() {
                // Determine which panel to go back to based on current state
                if (this.state.ui.currentPanel === 'vehicle') {
                    this.navigateToPanel('when');
                } else if (this.state.ui.currentPanel === 'when') {
                    this.navigateToPanel('where');
                } else {
                    // Default fallback
                    this.navigateToPanel('where');
                }
            }
            
            updateProgressSteps(activeStep) {
                this.els.progressSteps.forEach(step => {
                    const stepName = step.dataset.step;
                    step.classList.toggle('active', stepName === activeStep);
                    step.classList.toggle('completed', 
                        (activeStep === 'when' && stepName === 'where') ||
                        (activeStep === 'vehicle' && (stepName === 'where' || stepName === 'when')));
                });
                
                // Update progress lines
                if (this.els.progressLine) {
                    this.els.progressLine.classList.toggle('active', 
                        activeStep === 'when' || activeStep === 'vehicle');
                }
                if (this.els.progressLine2) {
                    this.els.progressLine2.classList.toggle('active', 
                        activeStep === 'vehicle');
                }
            }
            
            updateSummary() {
                if (this.state.locations.address && this.state.locations.airport) {
                    const from = this.state.mode === 'dropoff' 
                        ? this.truncateText(this.state.locations.address.address) 
                        : this.state.locations.airport.code;
                    const to = this.state.mode === 'dropoff' 
                        ? this.state.locations.airport.code 
                        : this.state.locations.address.address;
                    
                    this.els.routeSummaryText.textContent = `${from} → ${to}`;
                }
            }
            
            updateMapBadges() {
                if (this.state.dateTime.time) {
                    const pickupTime = new Date(this.state.dateTime.time);
                    const arrivalTime = new Date(pickupTime.getTime() + (this.state.route.duration || 45) * 60 * 1000);
                    
                    const formatTime = (date) => {
                        const hours = date.getHours();
                        const minutes = date.getMinutes();
                        const isPM = hours >= 12;
                        const displayHours = hours > 12 ? hours - 12 : (hours === 0 ? 12 : hours);
                        return `${displayHours}:${minutes.toString().padStart(2, '0')}`;
                    };
                    
                    this.els.mapPickupTime.textContent = formatTime(pickupTime);
                    this.els.mapArrivalTime.textContent = formatTime(arrivalTime);
                }
                
                if (this.state.locations.airport) {
                    const airportName = this.getAirportName(this.state.locations.airport.code);
                    this.els.mapLocationText.textContent = airportName + '...';
                }
            }
            
            truncateText(text, maxLength = 25) {
                const firstPart = text.split(',')[0];
                return firstPart.length > maxLength 
                    ? firstPart.substring(0, maxLength) + '...' 
                    : firstPart;
            }
            
            initializeDateTime() {
                this.initializeDateSelection();
                this.populateTimeOptions();
                this.setDefaultDateTime();
            }
            
            initializeDateSelection() {
                const today = new Date();
                const tomorrow = new Date(today);
                tomorrow.setDate(today.getDate() + 1);
                
                document.getElementById('todayDate').textContent = this.formatDateShort(today);
                document.getElementById('tomorrowDate').textContent = this.formatDateShort(tomorrow);
                
                document.getElementById('todayBtn').dataset.date = today.toISOString();
                document.getElementById('tomorrowBtn').dataset.date = tomorrow.toISOString();
                
                document.getElementById('todayBtn').addEventListener('click', () => this.selectDateByType('today'));
                document.getElementById('tomorrowBtn').addEventListener('click', () => this.selectDateByType('tomorrow'));
                document.getElementById('otherDatesBtn').addEventListener('click', () => this.selectDateByType('other'));
            }
            
            formatDateShort(date) {
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                               'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                return `${months[date.getMonth()]} ${date.getDate()}`;
            }
            
            populateTimeOptions() {
                for (let i = 1; i <= 12; i++) {
                    this.els.hourSelect.innerHTML += `<option value="${i}">${i}</option>`;
                }
                
                for (let i = 0; i < 60; i += 15) {
                    this.els.minuteSelect.innerHTML += `<option value="${i}">${i.toString().padStart(2, '0')}</option>`;
                }
                
                ['hourSelect', 'minuteSelect', 'ampmSelect'].forEach(id => {
                    this.els[id]?.addEventListener('change', () => this.updateDateTime());
                });
            }
            
            setDefaultDateTime() {
                const now = new Date();
                let hours = now.getHours();
                let minutes = Math.ceil(now.getMinutes() / 15) * 15;
                
                if (minutes === 60) {
                    minutes = 0;
                    hours += 1;
                }
                
                const ampm = hours >= 12 ? 'PM' : 'AM';
                let displayHours = hours;
                
                if (hours > 12) displayHours -= 12;
                if (hours === 0) displayHours = 12;
                
                this.els.hourSelect.value = displayHours;
                this.els.minuteSelect.value = minutes;
                this.els.ampmSelect.value = ampm;
                
                this.state.dateTime.date = now;
                this.updateDateTime();
            }
            
            selectDateByType(type) {
                document.querySelectorAll('.date-btn').forEach(btn => btn.classList.remove('active'));
                
                this.els.calendarContainer.classList.remove('visible');
                
                if (type === 'today') {
                    const todayBtn = document.getElementById('todayBtn');
                    todayBtn.classList.add('active');
                    this.state.dateTime.date = new Date(todayBtn.dataset.date);
                    this.updateDateTime();
                } else if (type === 'tomorrow') {
                    const tomorrowBtn = document.getElementById('tomorrowBtn');
                    tomorrowBtn.classList.add('active');
                    this.state.dateTime.date = new Date(tomorrowBtn.dataset.date);
                    this.updateDateTime();
                } else if (type === 'other') {
                    document.getElementById('otherDatesBtn').classList.add('active');
                    this.els.calendarContainer.classList.add('visible');
                    this.initializeCalendar();
                    return;
                }
            }
            
            initializeCalendar() {
                this.calendarState = {
                    viewMonth: this.state.dateTime.date.getMonth(),
                    viewYear: this.state.dateTime.date.getFullYear(),
                    selectedDate: this.state.dateTime.date
                };
                
                this.renderCalendar();
                
                this.els.prevMonthBtn.addEventListener('click', () => this.navigateMonth(-1));
                this.els.nextMonthBtn.addEventListener('click', () => this.navigateMonth(1));
            }
            
            navigateMonth(delta) {
                this.calendarState.viewMonth += delta;
                
                if (this.calendarState.viewMonth > 11) {
                    this.calendarState.viewMonth = 0;
                    this.calendarState.viewYear++;
                } else if (this.calendarState.viewMonth < 0) {
                    this.calendarState.viewMonth = 11;
                    this.calendarState.viewYear--;
                }
                
                this.renderCalendar();
            }
            
            renderCalendar() {
                const { viewMonth, viewYear, selectedDate } = this.calendarState;
                
                const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                              'July', 'August', 'September', 'October', 'November', 'December'];
                this.els.calendarMonthYear.textContent = `${months[viewMonth]} ${viewYear}`;
                
                const firstDay = new Date(viewYear, viewMonth, 1).getDay();
                const daysInMonth = new Date(viewYear, viewMonth + 1, 0).getDate();
                
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                let calendarHTML = '';
                
                const days = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'];
                days.forEach(day => {
                    calendarHTML += `<div class="calendar-day-header">${day}</div>`;
                });
                
                for (let i = 0; i < firstDay; i++) {
                    calendarHTML += '<div></div>';
                }
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(viewYear, viewMonth, day);
                    date.setHours(0, 0, 0, 0);
                    
                    const isPast = date < today;
                    const isToday = date.getTime() === today.getTime();
                    const isSelected = date.getDate() === selectedDate.getDate() && 
                           date.getMonth() === selectedDate.getMonth() && 
                           date.getFullYear() === selectedDate.getFullYear();
        
                    const classes = [
                        'calendar-day',
                        isPast ? 'disabled' : '',
                        isToday ? 'today' : '',
                        isSelected ? 'selected' : ''
                    ].filter(Boolean).join(' ');
                    
                    calendarHTML += `
                        <button 
                            class="${classes}" 
                            data-date="${date.toISOString()}"
                            ${isPast ? 'disabled' : ''}
                        >${day}</button>
                    `;
                }
                
                this.els.calendarGrid.innerHTML = calendarHTML;
                
                this.els.calendarGrid.querySelectorAll('.calendar-day:not(.disabled)').forEach(dayEl => {
                    dayEl.addEventListener('click', () => this.selectCalendarDate(dayEl));
                });
            }
            
            selectCalendarDate(dayEl) {
                const selectedDate = new Date(dayEl.dataset.date);
                this.calendarState.selectedDate = selectedDate;
                
                this.state.dateTime.date = selectedDate;
                
                this.els.calendarContainer.classList.remove('visible');
                
                document.querySelectorAll('.date-btn').forEach(btn => btn.classList.remove('active'));
                this.els.otherDatesBtn.classList.add('active');
                
                const dateValue = this.els.otherDatesBtn.querySelector('.date-value');
                dateValue.textContent = this.formatDateShort(selectedDate);
                
                this.els.otherDatesBtn.dataset.date = selectedDate.toISOString();
                
                this.updateDateTime();
            }
            
            updateDateTime() {
                const hours = parseInt(this.els.hourSelect.value);
                const minutes = parseInt(this.els.minuteSelect.value);
                const ampm = this.els.ampmSelect.value;
                
                const date = new Date(this.state.dateTime.date);
                let hour24 = hours;
                
                if (ampm === 'PM' && hours !== 12) hour24 += 12;
                if (ampm === 'AM' && hours === 12) hour24 = 0;
                
                date.setHours(hour24, minutes, 0, 0);
                
                const now = new Date();
                const isToday = date.toDateString() === now.toDateString();
                
                if (isToday && date < now) {
                    this.showTimeWarning();
                    
                    const minTime = new Date(now.getTime() + 30 * 60000);
                    const roundedMinutes = Math.ceil(minTime.getMinutes() / 15) * 15;
                    minTime.setMinutes(roundedMinutes);
                    
                    let minHours = minTime.getHours();
                    const minAmPm = minHours >= 12 ? 'PM' : 'AM';
                    if (minHours > 12) minHours -= 12;
                    if (minHours === 0) minHours = 12;
                    
                    this.els.hourSelect.value = minHours;
                    this.els.minuteSelect.value = minTime.getMinutes();
                    this.els.ampmSelect.value = minAmPm;
                    
                    date.setHours(minTime.getHours(), minTime.getMinutes(), 0, 0);
                } else {
                    this.hideTimeWarning();
                }
                
                this.state.dateTime.time = date;
                this.updateTimeNote();
                this.updateBookButton();
            }

            showTimeWarning() {
                let warning = document.getElementById('timeWarning');
                if (!warning) {
                    warning = document.createElement('div');
                    warning.id = 'timeWarning';
                    warning.className = 'time-warning';
                    warning.innerHTML = `
                        <span class="warning-icon">⚠️</span>
                        <span>Please select a time at least 30 minutes from now</span>
                    `;
                    this.els.timeNote.parentElement.insertBefore(warning, this.els.timeNote);
                }
                warning.classList.add('visible');
            }

            hideTimeWarning() {
                const warning = document.getElementById('timeWarning');
                if (warning) {
                    warning.classList.remove('visible');
                }
            }

            updateBookButton() {
                if (this.state.dateTime.time && this.els.bookBtn) {
                    const dateStr = this.state.dateTime.time.toLocaleDateString('en-US', {
                        weekday: 'short',
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    });
                    const timeStr = this.state.dateTime.time.toLocaleTimeString('en-US', {
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true
                    });
                    
                    const bookBtnSubText = this.els.bookBtn.querySelector('.btn-sub-text');
                    if (bookBtnSubText) {
                        bookBtnSubText.textContent = `${dateStr} · ${timeStr}`;
                    }
                }
            }
            
            updateTimeNote() {
                if (!this.state.dateTime.time || !this.state.route.duration) return;
                
                const pickupTime = new Date(this.state.dateTime.time);
                const arrivalTime = new Date(pickupTime.getTime() + this.state.route.duration * 60 * 1000);
                
                const formatTime = (date) => date.toLocaleTimeString('en-US', {
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });
                
                if (this.state.mode === 'dropoff') {
                    this.els.timeNote.innerHTML = `
                        <span>Pickup: <strong>${formatTime(pickupTime)}</strong></span>
                        <span>→</span>
                        <span>Airport arrival: <strong>${formatTime(arrivalTime)}</strong></span>
                    `;
                } else {
                    this.els.timeNote.innerHTML = `
                        <span>Airport pickup: <strong>${formatTime(pickupTime)}</strong></span>
                        <span>→</span>
                        <span>Destination arrival: <strong>${formatTime(arrivalTime)}</strong></span>
                    `;
                }
            }
            
            selectVehicle(vehicleType) {
                document.querySelectorAll('.vehicle-card').forEach(card => {
                    card.classList.remove('selected');
                });
                
                const selectedCard = document.querySelector(`[data-vehicle="${vehicleType}"]`);
                if (selectedCard) {
                    selectedCard.classList.add('selected');
                }
                
                // Get the price from the selected card
                const priceElement = selectedCard?.querySelector('.vehicle-price');
                const priceText = priceElement?.textContent || '$55';
                const price = parseFloat(priceText.replace(/[$,]/g, ''));
                
                this.state.vehicle = {
                    selected: vehicleType,
                    type: vehicleType,
                    name: selectedCard?.querySelector('.vehicle-name').textContent,
                    price: price || 55
                };
                
                if (this.state.route.distance && this.state.route.duration) {
                    const pricing = this.calculateVehiclePrice(vehicleType, this.state.route.distance, this.state.route.duration);
                    
                    if (pricing && !pricing.error) {
                        this.state.vehicle.pricing = pricing;
                        this.state.route.price = pricing.finalPrice;
                    } else {
                        this.state.route.price = null;
                    }
                } else {
                    // No pricing calculation without route data
                    this.state.route.price = null;
                }
                
                // Button is always enabled - no need to control disabled state
                // if (this.els.bookBtn) {
                //     this.els.bookBtn.disabled = false;
                // }
            }
            
            calculateVehiclePrice(vehicleType, distance, duration, options = {}) {
                if (this.pricingService) {
                    // Prepare options with all necessary data for accurate pricing
                    options.passengers = this.state.passengers;
                    
                    // Add dateTime for surge pricing calculations
                    if (this.state.dateTime.time) {
                        options.dateTime = new Date(this.state.dateTime.time);
                    }
                    
                    // Add origin/destination for popular route detection
                    if (this.state.locations.airport && this.state.locations.address) {
                        options.origin = this.state.locations.airport.code;
                        options.destination = this.state.locations.address.place_id || 'CUSTOM';
                    }
                    
                    console.log(`💵 Calculating price for ${vehicleType}:`, {
                        distance: distance + ' mi',
                        duration: Math.round(duration) + ' min', 
                        passengers: options.passengers,
                        dateTime: options.dateTime?.toLocaleString(),
                        origin: options.origin
                    });
                    
                    const pricing = this.pricingService.calculateVehiclePrice(vehicleType, distance, duration, options);
                    
                    if (pricing) {
                        console.log(`✅ ${vehicleType.toUpperCase()} pricing:`, {
                            basePrice: '$' + pricing.basePrice,
                            finalPrice: '$' + pricing.finalPrice,
                            protectionType: pricing.protectionApplied,
                            surcharges: pricing.breakdown.appliedSurcharges.length,
                            psychologicalPricing: pricing.finalPrice % 1 !== 0 ? 'Applied' : 'Rounded'
                        });
                    }
                    
                    return pricing;
                } else {
                    console.warn('⚠️ Pricing service unavailable for', vehicleType);
                    return { error: 'Pricing service unavailable' };
                }
            }
            
            updateVehiclePrices() {
                if (!this.state.route.distance || !this.state.route.duration) {
                    console.log('⏳ No route data available for pricing');
                    return;
                }
                
                const vehicleTypes = this.pricingService ? 
                    this.pricingService.getAllVehicles() : 
                    ['tesla', 'escalade', 'sprinter'];
                
                console.log('🔄 Updating prices for route:', {
                    distance: this.state.route.distance + ' miles',
                    duration: Math.round(this.state.route.duration) + ' minutes',
                    from: this.state.locations.address?.description || 'Custom address',
                    to: this.state.locations.airport?.name || 'Airport'
                });
                
                vehicleTypes.forEach(vehicleType => {
                    const pricing = this.calculateVehiclePrice(
                        vehicleType, 
                        this.state.route.distance, 
                        this.state.route.duration
                    );
                    
                    const priceElement = document.getElementById(`${vehicleType}-price`);
                    if (priceElement) {
                        // Add visual feedback for price updates
                        priceElement.classList.add('price-updating');
                        
                        if (pricing && !pricing.error) {
                            // Format price using pricing service
                            let formattedPrice;
                            if (this.pricingService && this.pricingService.formatPrice) {
                                formattedPrice = '$' + this.pricingService.formatPrice(pricing.finalPrice);
                            } else {
                                formattedPrice = '$' + pricing.finalPrice;
                            }
                            
                            priceElement.textContent = formattedPrice;
                            
                            // Log detailed pricing information
                            console.log(`💰 ${vehicleType.toUpperCase()}: ${formattedPrice}`, {
                                basePrice: '$' + pricing.basePrice,
                                finalPrice: '$' + pricing.finalPrice,
                                surcharges: pricing.breakdown.appliedSurcharges.length > 0 ? 
                                    pricing.breakdown.appliedSurcharges.map(s => s.description).join(', ') : 'None',
                                protectionModel: pricing.protectionApplied
                            });
                        } else {
                            // Show price unavailable when pricing service is not available
                            priceElement.textContent = 'Price unavailable';
                            console.warn(`❌ Could not calculate price for ${vehicleType} - pricing service unavailable`);
                        }
                        
                        // Remove visual feedback after animation
                        setTimeout(() => {
                            priceElement.classList.remove('price-updating');
                        }, 500);
                    } else {
                        console.warn(`❌ Price element not found for ${vehicleType}`);
                    }
                });
                
                // Log surge pricing information if applicable
                if (this.pricingService && this.state.dateTime.time) {
                    const surgeInfo = this.pricingService.checkSurgePeriod(new Date(this.state.dateTime.time));
                    if (surgeInfo.hasSurge) {
                        console.log('⚡ Surge pricing active:', {
                            surges: surgeInfo.surges.map(s => s.description).join(', '),
                            totalMultiplier: surgeInfo.totalMultiplier + 'x'
                        });
                    } else {
                        console.log('✅ No surge pricing applied');
                    }
                }
            }
            
            validateVehicleCapacity() {
                const passengerCount = this.state.passengers;
                
                this.els.vehicleCards.forEach(card => {
                    const vehicleType = card.dataset.vehicle;
                    
                    let canAccommodate = true;
                    
                    if (this.pricingService && this.pricingService.checkCapacity) {
                        canAccommodate = this.pricingService.checkCapacity(vehicleType, passengerCount);
                    } else if (this.vehicleConfig && this.vehicleConfig[vehicleType]) {
                        // Use fallback capacity check
                        const capacity = this.vehicleConfig[vehicleType].capacity;
                        canAccommodate = capacity && capacity.passengers >= passengerCount;
                    }
                    
                    if (!canAccommodate) {
                        card.style.opacity = '0.5';
                        card.style.pointerEvents = 'none';
                    } else {
                        card.style.opacity = '1';
                        card.style.pointerEvents = 'auto';
                    }
                });
            }
            
            async updateVehicleMap() {
                if (!this.els.vehicleMap) return;
                
                try {
                    if (!this.vehicleMap) {
                        await google.maps.importLibrary("maps");
                        
                        const mapOptions = {
                            center: { lat: 25.7617, lng: -80.1918 },
                            zoom: 11,
                            disableDefaultUI: true,
                            zoomControl: false,
                            mapTypeControl: false,
                            scaleControl: false,
                            streetViewControl: false,
                            rotateControl: false,
                            fullscreenControl: false,
                            styles: [
                                {
                                    featureType: "poi",
                                    elementType: "labels",
                                    stylers: [{ visibility: "off" }]
                                }
                            ]
                        };
                        
                        this.vehicleMap = new google.maps.Map(
                            this.els.vehicleMap,
                            mapOptions
                        );
                        
                        this.directionsRenderer = new google.maps.DirectionsRenderer({
                            map: this.vehicleMap,
                            suppressMarkers: false,
                            polylineOptions: {
                                strokeColor: '#FF6B35',
                                strokeOpacity: 0.8,
                                strokeWeight: 4
                            }
                        });
                        
                        // Initialize DirectionsService for map display
                        this.directionsService = new google.maps.DirectionsService();
                    }
                    
                    if (this.state.locations.address && this.state.locations.airport) {
                        const airportCoords = this.getAirportCoordinates(this.state.locations.airport.code);
                        
                        let origin, destination;
                        if (this.state.mode === 'dropoff') {
                            origin = this.state.locations.address.address;
                            destination = new google.maps.LatLng(airportCoords.lat, airportCoords.lng);
                        } else {
                            origin = new google.maps.LatLng(airportCoords.lat, airportCoords.lng);
                            destination = this.state.locations.address.address;
                        }
                        
                        const request = {
                            origin: origin,
                            destination: destination,
                            travelMode: google.maps.TravelMode.DRIVING
                        };
                        
                        this.directionsService.route(request, (result, status) => {
                            if (status === google.maps.DirectionsStatus.OK) {
                                this.directionsRenderer.setDirections(result);
                            }
                        });
                    }
                } catch (error) {
                    console.error('Map update error:', error);
                }
            }
            
            async confirmBooking() {
                const tripId = this.generateTripId();
                const bookingData = {
                    tripId: tripId,
                    passenger: {
                        name: this.state.guestData ? `${this.state.guestData.firstName} ${this.state.guestData.lastName}` : "Self",
                        guestData: this.state.guestData,
                        count: this.state.passengers,
                        phone: this.state.guestData?.phone || "+1 (555) 123-4567",
                        notes: this.state.pickupNotes
                    },
                    driver: {
                        name: "Carlos Martinez",
                        rating: 4.7,
                        vehicle: this.state.vehicle.name
                    },
                    route: {
                        from: this.state.mode === 'dropoff' 
                            ? this.state.locations.address.address 
                            : this.state.locations.airport.name,
                        to: this.state.mode === 'dropoff' 
                            ? this.state.locations.airport.name 
                            : this.state.locations.address.address
                    },
                    vehicle: this.state.vehicle,
                    dateTime: this.state.dateTime,
                    payment: {
                        method: this.state.paymentMethod,
                        promo: this.state.promoCode
                    },
                    pricing: {
                        base: this.state.vehicle.price || 55,
                        surge: 0,
                        discount: 0,
                        total: this.state.vehicle.price || 55
                    },
                    status: 'pending',
                    createdAt: new Date().toISOString()
                };
                
                // Calculate total amount
                const amount = bookingData.pricing.total;
                
                try {
                    // Show loading state
                    const bookBtn = document.getElementById('bookBtn');
                    const originalText = bookBtn.innerHTML;
                    bookBtn.innerHTML = '<span class="btn-main-text">Processing payment...</span>';
                    bookBtn.disabled = true;
                    
                    // Get payment controller
                    const paymentController = PaymentModal.getInstance();
                    const selectedPayment = paymentController.getSelectedPayment();
                    
                    if (!selectedPayment) {
                        alert('Please select a payment method first');
                        bookBtn.innerHTML = originalText;
                        bookBtn.disabled = false;
                        return;
                    }
                    
                    // Process payment with Stripe
                    const paymentResult = await window.StripePayment.processPayment(
                        bookingData,
                        selectedPayment
                    );
                    
                    if (!paymentResult.success) {
                        throw new Error(paymentResult.error || 'Payment failed');
                    }
                    
                    // Payment successful
                    bookingData.status = 'confirmed';
                    bookingData.payment.transactionId = paymentResult.paymentIntentId;
                    
                    localStorage.setItem(`trip_${tripId}`, JSON.stringify(bookingData));
                    
                    // Show confirmation
                    this.showBookingConfirmation(tripId, bookingData);
                    
                } catch (error) {
                    console.error('Payment failed:', error);
                    
                    // Restore button
                    const bookBtn = document.getElementById('bookBtn');
                    bookBtn.innerHTML = '<span class="btn-main-text">Book Service</span>';
                    bookBtn.disabled = false;
                    
                    // Show more detailed error message
                    const errorMessage = error.message || 'Payment failed. Please try again.';
                    this.showPaymentError(errorMessage);
                }
            }

            generateTripId() {
                return 'TRIP-' + Math.random().toString(36).substr(2, 9).toUpperCase();
            }
            
            showPaymentError(message) {
                // Create error modal
                const errorModal = document.createElement('div');
                errorModal.className = 'payment-error-modal';
                errorModal.innerHTML = `
                    <div class="payment-error-content">
                        <div class="payment-error-icon">❌</div>
                        <h3>Payment Failed</h3>
                        <p>${message}</p>
                        <button onclick="this.closest('.payment-error-modal').remove()" class="payment-error-btn">OK</button>
                    </div>
                `;
                
                // Add styles
                const style = document.createElement('style');
                style.textContent = `
                    .payment-error-modal {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0, 0, 0, 0.8);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10000;
                        animation: fadeIn 0.3s ease;
                    }
                    .payment-error-content {
                        background: #2C2C2E;
                        border-radius: 16px;
                        padding: 30px;
                        max-width: 400px;
                        text-align: center;
                        color: white;
                    }
                    .payment-error-icon {
                        font-size: 48px;
                        margin-bottom: 16px;
                    }
                    .payment-error-content h3 {
                        margin: 0 0 12px 0;
                        font-size: 24px;
                        color: #FF453A;
                    }
                    .payment-error-content p {
                        margin: 0 0 24px 0;
                        color: #8E8E93;
                        font-size: 16px;
                    }
                    .payment-error-btn {
                        background: #FF453A;
                        color: white;
                        border: none;
                        padding: 12px 32px;
                        border-radius: 10px;
                        font-size: 16px;
                        font-weight: 600;
                        cursor: pointer;
                    }
                    .payment-error-btn:hover {
                        background: #FF5449;
                    }
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                `;
                
                document.head.appendChild(style);
                document.body.appendChild(errorModal);
            }

            showBookingConfirmation(tripId, bookingData) {
                const confirmationElement = document.createElement('div');
                confirmationElement.className = 'booking-confirmation';
                confirmationElement.innerHTML = `
                    <div class="confirmation-content">
                        <div class="confirmation-header">
                            <h2>Booking Confirmed!</h2>
                            <p class="confirmation-trip-id">Trip ID: ${tripId}</p>
                        </div>
                        <div class="confirmation-details">
                            <div class="confirmation-item">
                                <span class="label">Pickup:</span>
                                <span class="value">${this.truncateText(bookingData.route.from, 35)}</span>
                            </div>
                            <div class="confirmation-item">
                                <span class="label">Destination:</span>
                                <span class="value">${this.truncateText(bookingData.route.to, 35)}</span>
                            </div>
                            <div class="confirmation-item">
                                <span class="label">Vehicle:</span>
                                <span class="value">${bookingData.vehicle.name}</span>
                            </div>
                            <div class="confirmation-item">
                                <span class="label">Time:</span>
                                <span class="value">${new Date(bookingData.dateTime.time).toLocaleString()}</span>
                            </div>
                        </div>
                        <button class="primary-btn" id="confirmationDoneBtn">Done</button>
                    </div>
                `;
                
                document.body.appendChild(confirmationElement);
                
                const doneBtn = document.getElementById('confirmationDoneBtn');
                doneBtn.addEventListener('click', () => {
                    confirmationElement.remove();
                    window.location.reload();
                });
            }
            
            preloadVehicleImages() {
                const vehicleImages = document.querySelectorAll('.vehicle-image[data-loaded="false"], .vehicle-image:not([data-loaded])');
                
                vehicleImages.forEach((img, index) => {
                    if (!img.hasAttribute('data-loading')) {
                        img.setAttribute('data-loading', 'true');
                        
                        const preloadImg = new Image();
                        preloadImg.onload = () => {
                            img.setAttribute('data-loaded', 'true');
                            
                            const loadingIndicator = img.parentElement?.querySelector('.vehicle-image-loading');
                            if (loadingIndicator) {
                                loadingIndicator.classList.add('hidden');
                            }
                        };
                        
                        preloadImg.onerror = () => {
                            console.error('Failed to load image:', img.src);
                        };
                        
                        preloadImg.src = img.src;
                    }
                });
            }
        }

        // Vehicle Carousel Class
        class VehicleCarousel {
            constructor(app) {
                this.app = app;
                this.currentIndex = 0;
                this.totalSlides = 3;
                this.isAnimating = false;
                this.touchStartX = 0;
                this.touchEndX = 0;
                this.isDragging = false;
                this.currentTransform = 0;
                this.selectedVehicle = 'tesla';
                
                this.vehicles = [
                    { id: 'tesla', name: 'Tesla Model Y' },
                    { id: 'escalade', name: 'Cadillac Escalade' },
                    { id: 'sprinter', name: 'Mercedes Sprinter' }
                ];
                
                this.init();
            }
            
            init() {
                this.cacheElements();
                this.bindEvents();
                this.updateCarousel();
            }
            
            cacheElements() {
                this.track = document.getElementById('carouselTrack');
                this.prevBtn = document.getElementById('prevBtn');
                this.nextBtn = document.getElementById('nextBtn');
                this.cards = document.querySelectorAll('.vehicle-card');
            }
            
            bindEvents() {
                if (!this.track) return;
                
                this.prevBtn?.addEventListener('click', () => this.goToPrevious());
                this.nextBtn?.addEventListener('click', () => this.goToNext());
                
                this.cards.forEach((card, index) => {
                    card.addEventListener('click', () => this.goToSlide(index));
                });
                
                this.track.addEventListener('touchstart', (e) => this.handleTouchStart(e), { passive: false });
                this.track.addEventListener('touchmove', (e) => this.handleTouchMove(e), { passive: false });
                this.track.addEventListener('touchend', (e) => this.handleTouchEnd(e), { passive: false });
            }
            
            goToSlide(index) {
                if (this.isAnimating || index === this.currentIndex) return;
                
                this.isAnimating = true;
                this.currentIndex = index;
                
                this.updateCarousel();
                
                setTimeout(() => {
                    this.isAnimating = false;
                }, 600);
            }
            
            goToNext() {
                const nextIndex = (this.currentIndex + 1) % this.totalSlides;
                this.goToSlide(nextIndex);
            }
            
            goToPrevious() {
                const prevIndex = (this.currentIndex - 1 + this.totalSlides) % this.totalSlides;
                this.goToSlide(prevIndex);
            }
            
            updateCarousel() {
                if (!this.track) return;
                
                // Calculate centering: center position (50%) minus half of card width (42.5%)
                const cardWidth = 85; // Card is 85% of container width
                const gap = 3.2; // Gap between cards
                const centerOffset = 7.5; // (100 - 85) / 2 = 7.5% to center a card
                
                // Position to center the active card
                const translateX = centerOffset - (this.currentIndex * (cardWidth + gap));
                this.track.style.transform = `translateX(${translateX}%)`;
                
                this.cards.forEach((card, index) => {
                    card.classList.remove('active', 'prev', 'next');
                    
                    if (index === this.currentIndex) {
                        card.classList.add('active');
                    } else if (index === this.currentIndex - 1 || (this.currentIndex === 0 && index === this.totalSlides - 1)) {
                        card.classList.add('prev');
                    } else if (index === this.currentIndex + 1 || (this.currentIndex === this.totalSlides - 1 && index === 0)) {
                        card.classList.add('next');
                    }
                });
                
                this.selectedVehicle = this.vehicles[this.currentIndex].id;
                
                if (this.app && this.app.updateVehiclePrices) {
                    this.app.updateVehiclePrices();
                }
            }
            
            handleTouchStart(e) {
                this.touchStartX = e.touches[0].clientX;
                this.isDragging = true;
                this.track.style.transition = 'none';
                this.currentTransform = -this.currentIndex * (85 + 3.2);
            }
            
            handleTouchMove(e) {
                if (!this.isDragging) return;
                
                const currentX = e.touches[0].clientX;
                const deltaX = currentX - this.touchStartX;
                
                if (Math.abs(deltaX) > 10) {
                    e.preventDefault();
                    
                    const dragOffset = (deltaX / window.innerWidth) * 100;
                    const newTransform = this.currentTransform + dragOffset;
                    this.track.style.transform = `translateX(${newTransform}%)`;
                }
            }
            
            handleTouchEnd(e) {
                if (!this.isDragging) return;
                
                this.isDragging = false;
                this.touchEndX = e.changedTouches[0].clientX;
                
                this.track.style.transition = 'transform 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                
                const deltaX = this.touchStartX - this.touchEndX;
                const swipeThreshold = 50;
                
                if (Math.abs(deltaX) > swipeThreshold) {
                    if (deltaX > 0) {
                        this.goToNext();
                    } else {
                        this.goToPrevious();
                    }
                } else {
                    this.updateCarousel();
                }
            }
        }

        // Store guest and notes data
        let guestData = null;
        let notesData = null;

        // Integration with new modal controllers
        
        // Update passenger button when modal data changes
        window.addEventListener('passengerDataChanged', function(e) {
            const passengerData = PassengerModal.getInstance().getPassengerData();
            if (window.airportApp) {
                window.airportApp.state.guestData = passengerData?.type === 'guest' ? passengerData.data : null;
            }
        });
        
        // Update pickup notes when modal data changes
        window.addEventListener('pickupNotesChanged', function(e) {
            const notesData = PickupNoteModal.getInstance().getPickupNotesData();
            if (window.airportApp) {
                window.airportApp.state.pickupNotes = notesData;
            }
        });
        
        // Update promotion when modal data changes
        window.addEventListener('promotionChanged', function(e) {
            const promoData = PromotionModal.getInstance().getPromoData();
            if (window.airportApp) {
                window.airportApp.state.promoCode = promoData?.code || null;
            }
        });
        
        // Other mobile-specific functions remain the same
        window.selectPaymentMethod = function() {
            const paymentBtn = document.querySelector('.payment-method-mobile');
            paymentBtn.style.background = 'linear-gradient(to right, #FF9933, #FF5733)';
            paymentBtn.style.color = 'white';
            
            setTimeout(() => {
                paymentBtn.style.background = '';
                paymentBtn.style.color = '';
            }, 300);
        };
        
        window.modifyDateTime = function() {
            const calBtn = document.querySelector('.calendar-button-mobile');
            calBtn.style.backgroundColor = '#f0f0f0';
            setTimeout(() => {
                calBtn.style.backgroundColor = '';
            }, 200);
            
            const app = window.airportApp;
            if (app) {
                app.navigateToPanel('when');
            }
        };

        // Google Maps initialization
        window.initGoogleMaps = function() {
            console.log('🗺️ Google Maps callback triggered');
            
            // Wait a moment to ensure the app is fully initialized
            setTimeout(() => {
                if (window.airportApp) {
                    console.log('🔄 Initializing autocomplete...');
                    
                    // Ensure elements are cached before initializing autocomplete
                    if (!window.airportApp.els.addressInput) {
                        console.log('🔄 Re-caching elements for autocomplete...');
                        window.airportApp.cacheElements();
                    }
                    
                    // Autocomplete now loads lazily on first focus
                    // window.airportApp.initializeAutocomplete();
                } else {
                    console.warn('⚠️ AirportApp not yet initialized, retrying...');
                    // Retry after a short delay
                    setTimeout(() => {
                        if (window.airportApp) {
                            // Autocomplete now loads lazily on first focus
                    // window.airportApp.initializeAutocomplete();
                        } else {
                            console.error('❌ AirportApp still not available after retry');
                        }
                    }, 500);
                }
            }, 100);
        };

        // Global callback function for Google Maps
        window.initGoogleMaps = function() {
            console.log('✅ Google Maps initialized successfully');
            
            // Initialize autocomplete when Google Maps is ready
            // Wait a bit to ensure the app is fully initialized
            setTimeout(() => {
                if (window.airportApp) {
                    try {
                        // Autocomplete now loads lazily on first focus
                    // window.airportApp.initializeAutocomplete();
                        console.log('✅ Autocomplete initialized from Google Maps callback');
                    } catch (error) {
                        console.error('❌ Failed to initialize autocomplete:', error);
                    }
                } else {
                    console.warn('⚠️ AirportApp not yet initialized when Google Maps loaded');
                    // Try again in a moment
                    setTimeout(() => {
                        if (window.airportApp) {
                            try {
                                // Autocomplete now loads lazily on first focus
                    // window.airportApp.initializeAutocomplete();
                                console.log('✅ Autocomplete initialized (delayed)');
                            } catch (error) {
                                console.error('❌ Failed to initialize autocomplete (delayed):', error);
                            }
                        }
                    }, 500);
                }
            }, 100);
        };

        // Load Google Maps script from proxy
        const script = document.createElement('script');
        
        // Use Railway proxy for Google Maps script
        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const apiUrl = isLocal ? 'http://localhost:3001/api/maps-script' : 'https://reliable-warmth-production-d382.up.railway.app/api/maps-script';
        
        debug.network('GET', apiUrl, { source: 'Google Maps Script' });
        script.src = apiUrl;
        script.defer = true;
        
        // Add success handling
        script.onload = function() {
            debug.success('Google Maps script loaded from proxy');
        };
        
        // Add error handling for script loading
        script.onerror = function() {
            debug.error('Failed to load Google Maps from proxy. Please ensure the server is running on port 3001.');
            // Note: No fallback with exposed API key - proxy is required for security
        };
        
        document.head.appendChild(script);

        // Initialize Application with proper timing
        let vehicleCarousel;
        
        // Initialize app immediately if DOM is ready, otherwise wait
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            // DOM is already loaded
            setTimeout(initializeApp, 10);
        }
        
        function initializeApp() {
            console.log('🚀 Initializing Airport Booking App...');
            
            // Initialize main app
            if (!window.airportApp) {
                window.airportApp = new AirportBookingApp();
            }
            
            // Initialize vehicle carousel
            if (window.airportApp && !vehicleCarousel) {
                vehicleCarousel = new VehicleCarousel(window.airportApp);
                console.log('🎠 Vehicle carousel initialized');
            }
            
            console.log('🎉 Application initialization complete');
        }
        
        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then((registration) => {
                        debug.success('Service Worker registered', registration.scope);
                        
                        // Check for updates periodically
                        setInterval(() => {
                            registration.update();
                        }, 60000); // Check every minute
                        
                        // Handle updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New version available
                                    if (confirm('A new version is available! Reload to update?')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        debug.error('Service Worker registration failed', error);
                    });
            });
        }
        
        // PWA Install Prompt
        let deferredPrompt;
        const installButton = document.createElement('button');
        installButton.id = 'installPWA';
        installButton.innerHTML = '📱 Install App';
        installButton.style.cssText = `
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #000;
            color: #fff;
            border: 2px solid #fff;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            z-index: 9999;
            transition: all 0.3s ease;
        `;
        document.body.appendChild(installButton);
        
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent the mini-infobar from appearing
            e.preventDefault();
            // Stash the event so it can be triggered later
            deferredPrompt = e;
            // Show install button
            installButton.style.display = 'block';
            
            debug.log('PWA install prompt available');
        });
        
        installButton.addEventListener('click', async () => {
            if (!deferredPrompt) return;
            
            // Show the install prompt
            deferredPrompt.prompt();
            
            // Wait for the user to respond
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                debug.success('PWA installed');
                installButton.style.display = 'none';
            } else {
                debug.log('PWA install declined');
            }
            
            deferredPrompt = null;
        });
        
        // Hide install button if already installed
        window.addEventListener('appinstalled', () => {
            installButton.style.display = 'none';
            debug.success('PWA is installed');
        });
        
        // Check if app is installed (for iOS)
        if (window.navigator.standalone) {
            debug.log('App is running in standalone mode (iOS)');
        }
        
        // Network status indicator
        function updateOnlineStatus() {
            const isOnline = navigator.onLine;
            if (!isOnline) {
                const offlineIndicator = document.createElement('div');
                offlineIndicator.id = 'offlineIndicator';
                offlineIndicator.innerHTML = '📵 Offline Mode';
                offlineIndicator.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    background: #ff4444;
                    color: white;
                    padding: 8px;
                    text-align: center;
                    font-size: 14px;
                    z-index: 10000;
                `;
                document.body.appendChild(offlineIndicator);
            } else {
                const indicator = document.getElementById('offlineIndicator');
                if (indicator) indicator.remove();
            }
        }
        
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        updateOnlineStatus();
    </script>
    
</body>
</html>