<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Cost Monitor - Airport Booking</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .dashboard {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: #1a1a1a;
            margin-bottom: 30px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #1a1a1a;
        }
        
        .stat-subtitle {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
        
        .cost-value {
            color: #FF5733;
        }
        
        .savings-value {
            color: #10B981;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .api-breakdown {
            margin-top: 20px;
        }
        
        .api-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        
        .api-row:last-child {
            border-bottom: none;
        }
        
        .api-name {
            font-weight: 500;
        }
        
        .api-stats {
            display: flex;
            gap: 20px;
            font-size: 14px;
        }
        
        .cached {
            color: #10B981;
        }
        
        .refresh-btn {
            background: #FF5733;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            margin-bottom: 20px;
        }
        
        .refresh-btn:hover {
            background: #FF6B35;
        }
        
        .recommendations {
            background: #FEF3C7;
            border: 1px solid #F59E0B;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .recommendations h3 {
            color: #92400E;
            margin-bottom: 10px;
        }
        
        .recommendations ul {
            list-style-position: inside;
            color: #92400E;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <h1>API Cost Monitor ðŸ“Š</h1>
        
        <button class="refresh-btn" onclick="refreshStats()">Refresh Stats</button>
        
        <div id="loadingState" class="loading">Loading stats...</div>
        
        <div id="dashboardContent" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-title">Total Requests Today</div>
                    <div class="stat-value" id="totalRequests">0</div>
                    <div class="stat-subtitle">All API calls</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-title">Cache Hit Rate</div>
                    <div class="stat-value savings-value" id="cacheHitRate">0%</div>
                    <div class="stat-subtitle">Requests served from cache</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-title">Estimated Monthly Cost</div>
                    <div class="stat-value cost-value" id="monthlyCost">$0</div>
                    <div class="stat-subtitle">After $200 free credit</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-title">Cost Savings</div>
                    <div class="stat-value savings-value" id="savingsAmount">$0</div>
                    <div class="stat-subtitle">From caching</div>
                </div>
            </div>
            
            <div class="chart-container">
                <h2>API Usage Breakdown</h2>
                <div class="api-breakdown" id="apiBreakdown">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
            
            <div class="recommendations" id="recommendations" style="display: none;">
                <h3>ðŸ’¡ Optimization Recommendations</h3>
                <ul id="recommendationsList"></ul>
            </div>
        </div>
    </div>

    <script>
        async function refreshStats() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('dashboardContent').style.display = 'none';
            
            try {
                const response = await fetch('http://localhost:3001/api/usage-stats');
                const data = await response.json();
                
                // Update main stats
                document.getElementById('totalRequests').textContent = 
                    data.summary.totalRequests.toLocaleString();
                document.getElementById('cacheHitRate').textContent = 
                    data.summary.cacheHitRate;
                document.getElementById('monthlyCost').textContent = 
                    `$${data.summary.estimatedMonthlyCost.estimatedCharge}`;
                
                // Calculate savings
                const totalCost = parseFloat(data.summary.estimatedMonthlyCost.totalBeforeCredit);
                const actualCost = parseFloat(data.summary.estimatedMonthlyCost.estimatedCharge);
                const cachedRequests = data.summary.totalCached;
                const avgCostPerRequest = totalCost / (data.summary.totalRequests || 1);
                const savings = (cachedRequests * avgCostPerRequest).toFixed(2);
                
                document.getElementById('savingsAmount').textContent = `$${savings}`;
                
                // Update API breakdown
                const breakdown = document.getElementById('apiBreakdown');
                breakdown.innerHTML = '';
                
                Object.entries(data.stats).forEach(([api, stats]) => {
                    const row = document.createElement('div');
                    row.className = 'api-row';
                    row.innerHTML = `
                        <div class="api-name">${formatApiName(api)}</div>
                        <div class="api-stats">
                            <span>Total: ${stats.count}</span>
                            <span class="cached">Cached: ${stats.cached}</span>
                            <span>Cost: $${calculateApiCost(api, stats).toFixed(2)}</span>
                        </div>
                    `;
                    breakdown.appendChild(row);
                });
                
                // Show recommendations
                showRecommendations(data);
                
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';
                
            } catch (error) {
                console.error('Failed to fetch stats:', error);
                document.getElementById('loadingState').textContent = 
                    'Failed to load stats. Make sure the server is running.';
            }
        }
        
        function formatApiName(api) {
            const names = {
                autocomplete: 'Places Autocomplete',
                placeDetails: 'Place Details',
                directions: 'Directions API',
                geocoding: 'Geocoding API'
            };
            return names[api] || api;
        }
        
        function calculateApiCost(api, stats) {
            const costs = {
                autocomplete: 0.00283,
                placeDetails: 0.017,
                directions: 0.005,
                geocoding: 0.005
            };
            
            const billableRequests = stats.count - stats.cached;
            return billableRequests * (costs[api] || 0) * 30; // Monthly projection
        }
        
        function showRecommendations(data) {
            const recommendations = [];
            const cacheRate = parseFloat(data.summary.cacheHitRate);
            
            if (cacheRate < 20) {
                recommendations.push('Cache hit rate is low. Ensure caching is properly implemented.');
            }
            
            if (data.stats.autocomplete.count > data.stats.placeDetails.count * 5) {
                recommendations.push('High autocomplete-to-details ratio. Check if session tokens are working.');
            }
            
            if (data.stats.directions.cached < data.stats.directions.count * 0.3) {
                recommendations.push('Low directions cache rate. Consider caching popular routes.');
            }
            
            if (data.summary.totalRequests > 3000) {
                recommendations.push('High daily usage. Monitor costs closely as you approach free tier limits.');
            }
            
            if (recommendations.length > 0) {
                document.getElementById('recommendations').style.display = 'block';
                const list = document.getElementById('recommendationsList');
                list.innerHTML = recommendations.map(r => `<li>${r}</li>`).join('');
            }
        }
        
        // Auto-refresh every 30 seconds
        setInterval(refreshStats, 30000);
        
        // Initial load
        refreshStats();
    </script>
</body>
</html>